\section{Semantics}

\hide{
\begin{code}%
\>[0]\AgdaSymbol{\{-\#}\AgdaSpace{}%
\AgdaKeyword{OPTIONS}\AgdaSpace{}%
\AgdaPragma{--rewriting}\AgdaSpace{}%
\AgdaSymbol{\#-\}}\<%
\\
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{Semantics}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\end{code}
}

\hide{
\begin{code}%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{CoreLanguage}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Pattern}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{Pattern}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}∙\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}⊗\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}-Env}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{match}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Context}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Context}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{renaming}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{},\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{to}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}-,\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Expression}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Expr}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{toTerm}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Product}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}×\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{},\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.List}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{List}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}∷\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Maybe}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{Maybe}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{just}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{nothing}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Failable}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>=\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\end{code}
}

\hide{
\begin{code}%
\>[0]\AgdaKeyword{private}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{variable}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaGeneralizable{γ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Scope}\<%
\\
%
\>[4]\AgdaGeneralizable{d}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Dir}\<%
\end{code}
}

Given the way that we represent typing rules, our type for $β$-rules
should not look unfamiliar. We match a rule by matching patterns for the
target, target type and eliminator and construct the reduced term
and its type from an expression and the resulting environment we
computed in the matching process.

Since we are matching a rule by matching patterns, the target, type and
eliminator in question must be in weak head normal form \hl{verify} and
so care should be taken to compute these forms before attempting to match
a β-rule.
\begin{code}%
\>[0]\AgdaKeyword{record}\AgdaSpace{}%
\AgdaRecord{β-rule}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitiveType{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{field}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaField{target}%
\>[16]\AgdaSymbol{:}%
\>[19]\AgdaDatatype{Pattern}\AgdaSpace{}%
\AgdaNumber{0}\<%
\\
%
\>[4]\AgdaField{targetType}%
\>[16]\AgdaSymbol{:}%
\>[19]\AgdaDatatype{Pattern}\AgdaSpace{}%
\AgdaNumber{0}\<%
\\
%
\>[4]\AgdaField{eliminator}%
\>[16]\AgdaSymbol{:}%
\>[19]\AgdaDatatype{Pattern}\AgdaSpace{}%
\AgdaNumber{0}\<%
\\
%
\>[4]\AgdaField{redTerm}%
\>[16]\AgdaSymbol{:}%
\>[19]\AgdaFunction{Expr}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{target}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∙}}\AgdaSpace{}%
\AgdaField{targetType}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∙}}\AgdaSpace{}%
\AgdaField{eliminator}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{const}\AgdaSpace{}%
\AgdaNumber{0}\<%
\\
%
\>[4]\AgdaField{redType}%
\>[16]\AgdaSymbol{:}%
\>[19]\AgdaFunction{Expr}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{target}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∙}}\AgdaSpace{}%
\AgdaField{targetType}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∙}}\AgdaSpace{}%
\AgdaField{eliminator}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{const}\AgdaSpace{}%
\AgdaNumber{0}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{β-match}%
\>[11]\AgdaSymbol{:}%
\>[14]\AgdaSymbol{(}\AgdaBound{targ}%
\>[21]\AgdaSymbol{:}%
\>[24]\AgdaFunction{Term}\AgdaSpace{}%
\AgdaInductiveConstructor{const}\AgdaSpace{}%
\AgdaGeneralizable{γ}\AgdaSymbol{)}%
\>[39]\AgdaSymbol{→}\<%
\\
%
\>[14]\AgdaSymbol{(}\AgdaBound{type}%
\>[21]\AgdaSymbol{:}%
\>[24]\AgdaFunction{Term}\AgdaSpace{}%
\AgdaInductiveConstructor{const}\AgdaSpace{}%
\AgdaGeneralizable{γ}\AgdaSymbol{)}%
\>[39]\AgdaSymbol{→}\<%
\\
%
\>[14]\AgdaSymbol{(}\AgdaBound{elim}%
\>[21]\AgdaSymbol{:}%
\>[24]\AgdaFunction{Term}\AgdaSpace{}%
\AgdaInductiveConstructor{const}\AgdaSpace{}%
\AgdaGeneralizable{γ}\AgdaSymbol{)}%
\>[39]\AgdaSymbol{→}\<%
\\
%
\>[14]\AgdaDatatype{Maybe}%
\>[80I]\AgdaSymbol{(((}\AgdaGeneralizable{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊗}}\AgdaSpace{}%
\AgdaField{target}\AgdaSymbol{)}%
\>[40]\AgdaOperator{\AgdaInductiveConstructor{∙}}\<%
\\
\>[80I][@{}l@{\AgdaIndent{0}}]%
\>[22]\AgdaSymbol{(}\AgdaGeneralizable{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊗}}\AgdaSpace{}%
\AgdaField{targetType}\AgdaSymbol{)}%
\>[40]\AgdaOperator{\AgdaInductiveConstructor{∙}}\<%
\\
%
\>[22]\AgdaSymbol{(}\AgdaGeneralizable{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊗}}\AgdaSpace{}%
\AgdaField{eliminator}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{-Env}}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaFunction{β-match}\AgdaSpace{}%
\AgdaBound{tar}\AgdaSpace{}%
\AgdaBound{ty}\AgdaSpace{}%
\AgdaBound{el}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[92I]\AgdaKeyword{do}\<%
\\
\>[92I][@{}l@{\AgdaIndent{0}}]%
\>[24]\AgdaBound{t-env}%
\>[31]\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{match}\AgdaSpace{}%
\AgdaBound{tar}\AgdaSpace{}%
\AgdaField{target}\<%
\\
%
\>[24]\AgdaBound{ty-env}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{match}\AgdaSpace{}%
\AgdaBound{ty}\AgdaSpace{}%
\AgdaField{targetType}\<%
\\
%
\>[24]\AgdaBound{e-env}%
\>[31]\AgdaOperator{\AgdaFunction{←}}\AgdaSpace{}%
\AgdaFunction{match}\AgdaSpace{}%
\AgdaBound{el}\AgdaSpace{}%
\AgdaField{eliminator}\<%
\\
%
\>[24]\AgdaInductiveConstructor{just}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{t-env}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∙}}\AgdaSpace{}%
\AgdaBound{ty-env}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∙}}\AgdaSpace{}%
\AgdaBound{e-env}\AgdaSymbol{)}\<%
\\
\>[92I][@{}l@{\AgdaIndent{0}}]%
\>[23]\AgdaKeyword{where}\<%
\\
\>[23][@{}l@{\AgdaIndent{0}}]%
\>[25]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Data.Maybe}\<%
\\
\>[0]\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaFunction{β-reduce}%
\>[12]\AgdaSymbol{:}%
\>[15]\AgdaSymbol{((}\AgdaGeneralizable{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊗}}\AgdaSpace{}%
\AgdaField{target}\AgdaSymbol{)}%
\>[34]\AgdaOperator{\AgdaInductiveConstructor{∙}}\<%
\\
\>[15][@{}l@{\AgdaIndent{0}}]%
\>[16]\AgdaSymbol{(}\AgdaGeneralizable{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊗}}\AgdaSpace{}%
\AgdaField{targetType}\AgdaSymbol{)}%
\>[34]\AgdaOperator{\AgdaInductiveConstructor{∙}}\<%
\\
%
\>[16]\AgdaSymbol{(}\AgdaGeneralizable{γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{⊗}}\AgdaSpace{}%
\AgdaField{eliminator}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{-Env}}%
\>[40]\AgdaSymbol{→}\<%
\\
%
\>[15]\AgdaFunction{Term}\AgdaSpace{}%
\AgdaInductiveConstructor{compu}\AgdaSpace{}%
\AgdaGeneralizable{γ}\<%
\\
%
\>[2]\AgdaFunction{β-reduce}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{tenv}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∙}}\AgdaSpace{}%
\AgdaBound{tyEnv}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∙}}\AgdaSpace{}%
\AgdaBound{eenv}\AgdaSymbol{)}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaSymbol{=}%
\>[123I]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{toTerm}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{tenv}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∙}}\AgdaSpace{}%
\AgdaBound{tyEnv}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∙}}\AgdaSpace{}%
\AgdaBound{eenv}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaField{redTerm}\AgdaSpace{}%
\AgdaKeyword{in}\<%
\\
\>[.][@{}l@{}]\<[123I]%
\>[6]\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{T}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{toTerm}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{tenv}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∙}}\AgdaSpace{}%
\AgdaBound{tyEnv}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∙}}\AgdaSpace{}%
\AgdaBound{eenv}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaField{redType}\AgdaSpace{}%
\AgdaKeyword{in}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{T}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{β-rule}\<%
\end{code}
We then define a function that will attempt a reduction with regards
to a list of β-rules by trying to match and apply a rule.
\begin{code}%
\>[0]\AgdaFunction{reduce}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[148I]\AgdaDatatype{List}\AgdaSpace{}%
\AgdaRecord{β-rule}%
\>[34]\AgdaSymbol{→}\<%
\\
\>[.][@{}l@{}]\<[148I]%
\>[9]\AgdaSymbol{(}\AgdaBound{tar}%
\>[17]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Term}\AgdaSpace{}%
\AgdaInductiveConstructor{const}\AgdaSpace{}%
\AgdaGeneralizable{γ}\AgdaSymbol{)}%
\>[34]\AgdaSymbol{→}\<%
\\
%
\>[9]\AgdaSymbol{(}\AgdaBound{tType}%
\>[17]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Term}\AgdaSpace{}%
\AgdaInductiveConstructor{const}\AgdaSpace{}%
\AgdaGeneralizable{γ}\AgdaSymbol{)}%
\>[34]\AgdaSymbol{→}\<%
\\
%
\>[9]\AgdaSymbol{(}\AgdaBound{elim}%
\>[17]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Term}\AgdaSpace{}%
\AgdaInductiveConstructor{const}\AgdaSpace{}%
\AgdaGeneralizable{γ}\AgdaSymbol{)}%
\>[34]\AgdaSymbol{→}\<%
\\
%
\>[9]\AgdaDatatype{Failable}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Term}\AgdaSpace{}%
\AgdaInductiveConstructor{compu}\AgdaSpace{}%
\AgdaGeneralizable{γ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{reduce}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSpace{}%
\AgdaBound{ta}\AgdaSpace{}%
\AgdaBound{ty}\AgdaSpace{}%
\AgdaBound{el}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{fail}\AgdaSpace{}%
\AgdaString{"Failed to reduce"}\<%
\\
\>[0]\AgdaFunction{reduce}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{rule}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{rules}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{ta}\AgdaSpace{}%
\AgdaBound{ty}\AgdaSpace{}%
\AgdaBound{el}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{β-match}\AgdaSpace{}%
\AgdaBound{rule}\AgdaSpace{}%
\AgdaBound{ta}\AgdaSpace{}%
\AgdaBound{ty}\AgdaSpace{}%
\AgdaBound{el}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{nothing}%
\>[15]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{reduce}\AgdaSpace{}%
\AgdaBound{rules}\AgdaSpace{}%
\AgdaBound{ta}\AgdaSpace{}%
\AgdaBound{ty}\AgdaSpace{}%
\AgdaBound{el}\<%
\\
\>[0]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{just}\AgdaSpace{}%
\AgdaBound{env}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{succeed}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{β-reduce}\AgdaSpace{}%
\AgdaBound{rule}\AgdaSpace{}%
\AgdaBound{env}\AgdaSymbol{)}\<%
\end{code}

Finally we define normalization in terms of a list of β-rules but also
in terms of some function that may infer types for us. In practice we will
supply our type-inference function (defined later) "pre-loaded" with typing
rules.

Our approach to normalization is naive. We make a post-order traversal of
the syntax tree and where processing eliminations, stuck eliminations are
embedded as "thunk" terms (although the target and eliminator are reduced
where possible as would be expected in post order traversal), whereas
reducable eliminations are reduced and the resulting term is also normalized.

As we pass under binders, we must extend the context, however the type of
the newly bound variable is not known and so the context is extended with
a special symbol to indicate this. Later we will see that the parser is
unable to produce this symbol and so it is safe to use for this purpose.
\hl{make sure this is so}. The type-synthesis process will synthesis the
type of a variable by looking it up in the context. During this process
it also checks that what it retrieves from the context is indeed a type.
Since there cannot exists a type rule for $'⊤'$ \hl{(change)} we cannot
successfully infer or check the type for the newly bound variable insuring
that such variables of unknown type cannot involve themselves in
computation in which they have no right.

\begin{itemize}
  \item Normalization by evaluation would be more efficient
  \item The current normalization process has no guarantees w.r.t
        termination
\end{itemize}

\hide{
\begin{code}%
\>[0]\AgdaSymbol{\{-\#}\AgdaSpace{}%
\AgdaKeyword{TERMINATING}\AgdaSpace{}%
\AgdaSymbol{\#-\}}\<%
\end{code}
}
\begin{code}%
\>[0]\AgdaFunction{normalize}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[198I]\AgdaDatatype{List}\AgdaSpace{}%
\AgdaRecord{β-rule}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
\>[.][@{}l@{}]\<[198I]%
\>[12]\AgdaSymbol{(∀}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{δ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Context}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Term}\AgdaSpace{}%
\AgdaInductiveConstructor{compu}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaDatatype{Failable}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Term}\AgdaSpace{}%
\AgdaInductiveConstructor{const}\AgdaSpace{}%
\AgdaBound{δ}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[12]\AgdaFunction{Context}\AgdaSpace{}%
\AgdaGeneralizable{γ}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[12]\AgdaFunction{Term}\AgdaSpace{}%
\AgdaGeneralizable{d}\AgdaSpace{}%
\AgdaGeneralizable{γ}\AgdaSpace{}%
\AgdaSymbol{→}\<%
\\
%
\>[12]\AgdaFunction{Term}\AgdaSpace{}%
\AgdaInductiveConstructor{const}\AgdaSpace{}%
\AgdaGeneralizable{γ}\<%
\\
\>[0]\AgdaFunction{normalize}\AgdaSpace{}%
\AgdaBound{rs}\AgdaSpace{}%
\AgdaBound{infer}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{norm}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaFunction{norm}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Context}\AgdaSpace{}%
\AgdaGeneralizable{γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Term}\AgdaSpace{}%
\AgdaGeneralizable{d}\AgdaSpace{}%
\AgdaGeneralizable{γ}\AgdaSpace{}%
\AgdaSymbol{→}\AgdaSpace{}%
\AgdaFunction{Term}\AgdaSpace{}%
\AgdaInductiveConstructor{const}\AgdaSpace{}%
\AgdaGeneralizable{γ}\<%
\\
%
\>[4]\AgdaComment{-- to do: change '⊤' to "unknown" ...}\<%
\\
%
\>[4]\AgdaFunction{norm}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{const}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{bind}\AgdaSpace{}%
\AgdaBound{t}\AgdaSymbol{)}%
\>[34]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{bind}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{norm}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Γ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{-,}}\AgdaSpace{}%
\AgdaInductiveConstructor{`}\AgdaSpace{}%
\AgdaString{'⊤'}\AgdaSpace{}%
\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{t}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaFunction{norm}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{compu}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{elim}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaBound{e}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{norm}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaFunction{norm}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{e}\<%
\\
%
\>[4]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{t'}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaBound{e'}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaBound{infer}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{t}\<%
\\
%
\>[4]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{fail}\AgdaSpace{}%
\AgdaBound{m}%
\>[25]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{thunk}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{elim}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaBound{e'}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{succeed}\AgdaSpace{}%
\AgdaBound{ty}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaFunction{reduce}\AgdaSpace{}%
\AgdaBound{rs}\AgdaSpace{}%
\AgdaBound{t'}\AgdaSpace{}%
\AgdaBound{ty}\AgdaSpace{}%
\AgdaBound{e'}\<%
\\
%
\>[4]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{succeed}\AgdaSpace{}%
\AgdaBound{x}%
\>[25]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{norm}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
%
\>[4]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{fail}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaKeyword{with}\AgdaSpace{}%
\AgdaBound{t'}\<%
\\
%
\>[4]\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{|}\AgdaSpace{}%
\AgdaInductiveConstructor{thunk}\AgdaSpace{}%
\AgdaBound{x}%
\>[25]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{thunk}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{elim}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaBound{e'}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaCatchallClause{\AgdaSymbol{...}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{|}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{\AgdaUnderscore{}}}%
\>[25]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{thunk}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{elim}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{t'}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{ty}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{e'}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaComment{--- ...}\<%
\end{code}
\hide{
\begin{code}%
%
\>[4]\AgdaFunction{norm}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{const}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{`}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[34]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{`}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
%
\>[4]\AgdaFunction{norm}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{const}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∙}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSymbol{)}%
\>[34]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{norm}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{s}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∙}}\AgdaSpace{}%
\AgdaFunction{norm}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{t}\<%
\\
%
\>[4]\AgdaFunction{norm}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{const}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{thunk}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[34]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{norm}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
%
\>[4]\AgdaFunction{norm}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{compu}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[34]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{thunk}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaFunction{norm}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{d}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{compu}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{∷}}\AgdaSpace{}%
\AgdaBound{T}\AgdaSymbol{)}%
\>[34]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{norm}\AgdaSpace{}%
\AgdaBound{Γ}\AgdaSpace{}%
\AgdaBound{t}\<%
\end{code}
}
